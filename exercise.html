<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è¿åŠ¨ - å¥èº«ç®¡ç†APP</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„è¿åŠ¨</h1>

        <!-- ä»Šæ—¥è¿åŠ¨æ€»æ¶ˆè€— -->
        <div style="text-align: center; margin-bottom: 30px;">
            <div class="circle-card large" style="display: inline-block;">
                <div class="value" id="totalExerciseCalories">0.0</div>
                <div class="label">è¿åŠ¨æ¶ˆè€—</div>
                <div class="label">å¤§å¡</div>
            </div>
        </div>

        <!-- æœ‰æ°§è¿åŠ¨åŒº -->
        <div style="margin-bottom: 30px;">
            <h3>æœ‰æ°§è¿åŠ¨</h3>
            <div class="exercise-grid">
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('è·‘æ­¥', 8.0, 'aerobic')">è·‘æ­¥</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('è·³ç»³', 10.0, 'aerobic')">è·³ç»³</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('çˆ¬æ¥¼æ¢¯', 7.5, 'aerobic')">çˆ¬æ¥¼æ¢¯</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('æ•£æ­¥', 3.5, 'aerobic')">æ•£æ­¥</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('æ¸¸æ³³', 7.0, 'aerobic')">æ¸¸æ³³</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('éª‘è‡ªè¡Œè½¦', 6.8, 'aerobic')">éª‘è‡ªè¡Œè½¦</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('æœ‰æ°§èˆè¹ˆ', 6.0, 'aerobic')">æœ‰æ°§èˆè¹ˆ</button>
                <button class="exercise-btn aerobic-btn" onclick="openDurationInput('æ¤­åœ†æœº', 5.5, 'aerobic')">æ¤­åœ†æœº</button>
            </div>
            <button class="btn btn-primary" onclick="openManualAerobicModal()" style="margin-top: 15px; width: 100%;">æ‰‹åŠ¨æ·»åŠ æœ‰æ°§è¿åŠ¨</button>
            <div id="aerobicExerciseList" class="item-list aerobic-exercise-list" style="margin-top: 20px;"></div>
        </div>

        <!-- æ— æ°§è¿åŠ¨åŒº -->
        <div style="margin-bottom: 80px;">
            <h3>æ— æ°§è¿åŠ¨</h3>
            <div class="exercise-grid">
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('èƒ¸éƒ¨', 6.0, 'anaerobic')">èƒ¸éƒ¨</button>
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('èƒŒéƒ¨', 5.5, 'anaerobic')">èƒŒéƒ¨</button>
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('è…¿éƒ¨', 7.0, 'anaerobic')">è…¿éƒ¨</button>
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('æ‰‹è‡‚', 4.5, 'anaerobic')">æ‰‹è‡‚</button>
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('è‚©è†€', 5.0, 'anaerobic')">è‚©è†€</button>
                <button class="exercise-btn anaerobic-btn" onclick="openDurationInput('è…¹éƒ¨', 4.0, 'anaerobic')">è…¹éƒ¨</button>
            </div>
            <div id="anaerobicExerciseList" class="item-list anaerobic-exercise-list" style="margin-top: 20px;"></div>
        </div>

        <!-- ä¿å­˜æŒ‰é’® -->
        <div style="position: fixed; bottom: 70px; left: 0; right: 0; padding: 0 20px; max-width: 480px; margin: 0 auto;">
            <button class="btn btn-primary" onclick="saveExerciseRecord()">ä¿å­˜ä»Šæ—¥è¿åŠ¨</button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="nav">
        <button class="nav-btn" data-page="index">
            <i>ğŸ‘¤</i>
            <span>ä¸ªäºº</span>
        </button>
        <button class="nav-btn" data-page="diet">
            <i>ğŸ½ï¸</i>
            <span>é¥®é£Ÿ</span>
        </button>
        <button class="nav-btn active" data-page="exercise">
            <i>ğŸƒ</i>
            <span>è¿åŠ¨</span>
        </button>
        <button class="nav-btn" data-page="advice">
            <i>ğŸ’¡</i>
            <span>å»ºè®®</span>
        </button>
    </div>

    <!-- æ—¶é•¿è¾“å…¥å¼¹çª— -->
    <div id="durationInputModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¾“å…¥æ—¶é•¿</h3>
                <button class="btn-close" onclick="closeDurationInputModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label for="exerciseDuration">æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" id="exerciseDuration" placeholder="è¾“å…¥æ—¶é•¿" min="1" step="1">
                </div>
                <div style="text-align: center; margin: 15px 0;">
                    <div>çƒ­é‡æ¶ˆè€—ï¼š<span id="calculatedExerciseCalories">0.0</span> å¤§å¡</div>
                </div>
                <button class="btn btn-primary" onclick="confirmExerciseAddition()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- æ‰‹åŠ¨æ·»åŠ æœ‰æ°§è¿åŠ¨å¼¹çª— -->
    <div id="manualAerobicModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ‰‹åŠ¨æ·»åŠ æœ‰æ°§è¿åŠ¨</h3>
                <button class="btn-close" onclick="closeManualAerobicModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label for="manualExerciseName">è¿åŠ¨åç§°</label>
                    <input type="text" id="manualExerciseName" placeholder="è¾“å…¥è¿åŠ¨åç§°">
                </div>
                <div class="input-group">
                    <label for="manualExerciseDuration">æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" id="manualExerciseDuration" placeholder="è¾“å…¥æ—¶é•¿" min="1" step="1">
                </div>
                <div class="input-group">
                    <label for="manualExerciseCalories">çƒ­é‡æ¶ˆè€— (å¤§å¡)</label>
                    <input type="number" id="manualExerciseCalories" placeholder="è¾“å…¥çƒ­é‡" min="0" step="0.1">
                </div>
                <button class="btn btn-primary" onclick="addManualAerobicExercise()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/app.js"></script>
    <script>
        // è¿åŠ¨è®°å½•é¡µåˆå§‹åŒ–
        let currentExercise = null;
        let durationModal = null;
        let manualAerobicModal = null;
        let currentDate = new Date();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å¼¹çª—
            durationModal = new Modal(document.getElementById('durationInputModal'));
            manualAerobicModal = new Modal(document.getElementById('manualAerobicModal'));
            
            // åŠ è½½è¿åŠ¨è®°å½•
            loadExerciseRecord();
            
            // æ›´æ–°æ€»æ¶ˆè€—
            updateTotalExerciseCalories();
            
            // æ—¶é•¿è¾“å…¥äº‹ä»¶
            document.getElementById('exerciseDuration').addEventListener('input', function() {
                if (currentExercise && this.value) {
                    const duration = parseFloat(this.value);
                    const calories = calculateExerciseCalories(currentExercise.name, currentExercise.met, duration);
                    document.getElementById('calculatedExerciseCalories').textContent = Utils.toFixedOne(calories);
                }
            });
            
            // è®°å½•æœ€è¿‘ç‚¹å‡»çš„è¿åŠ¨åç§°
            let lastClickedSport = '';
            
            // ä¸ºä¸Šæ–¹æ¯ä¸ªè¿åŠ¨æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œè‡ªåŠ¨ä¼ é€’è¿åŠ¨åç§°
            document.querySelectorAll('.exercise-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // è·å–æŒ‰é’®å¯¹åº”çš„è¿åŠ¨åç§°ï¼ˆå¦‚â€œè·‘æ­¥â€â€œè·³ç»³â€ï¼‰
                    const sportName = this.textContent.trim();
                    lastClickedSport = sportName;
                    
                    // æ›¿æ¢å†å²â€œæœªçŸ¥è¿åŠ¨â€è®°å½•
                    const unknownRecords = document.querySelectorAll('.exercise-name');
                    const record = DataManager.getExerciseRecord(currentDate);
                    let updated = false;
                    
                    unknownRecords.forEach((span, index) => {
                        if (span.textContent === 'æœªçŸ¥è¿åŠ¨' && record.exercises[index]) {
                            span.textContent = lastClickedSport;
                            // åŒæ­¥æ›´æ–°DataManagerä¸­çš„æ•°æ®
                            record.exercises[index].name = lastClickedSport;
                            updated = true;
                        }
                    });
                    
                    // å¦‚æœæœ‰æ›´æ–°ï¼Œä¿å­˜å¹¶é‡æ–°åŠ è½½
                    if (updated) {
                        DataManager.saveExerciseRecord(currentDate, record);
                        loadExerciseRecord();
                    }
                });
            });
        });

        // è®¡ç®—è¿åŠ¨çƒ­é‡æ¶ˆè€—
        function calculateExerciseCalories(name, met, durationMinutes) {
            const userInfo = DataManager.getUserInfo();
            if (!userInfo || !userInfo.weight) {
                alert('è¯·å…ˆåœ¨ä¸ªäººä¿¡æ¯é¡µå¡«å†™ä½“é‡ï¼');
                return 0;
            }
            
            const weight = userInfo.weight;
            const durationHours = durationMinutes / 60;
            const calories = met * weight * durationHours;
            return calories;
        }

        // æ‰“å¼€æ—¶é•¿è¾“å…¥å¼¹çª—
        function openDurationInput(exerciseName, met, type) {
            currentExercise = { name: exerciseName, met, type };
            document.getElementById('exerciseDuration').value = '';
            document.getElementById('calculatedExerciseCalories').textContent = '0.0';
            // æ›´æ–°å¼¹çª—æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰è¿åŠ¨åç§°
            const modalTitle = document.querySelector('.modal-title');
            if (modalTitle) {
                modalTitle.textContent = `è¾“å…¥${exerciseName}æ—¶é•¿`;
            }
            durationModal.open();
        }

        // å…³é—­æ—¶é•¿è¾“å…¥å¼¹çª—
        function closeDurationInputModal() {
            durationModal.close();
        }

        // ç¡®è®¤æ·»åŠ è¿åŠ¨
        function confirmExerciseAddition() {
            const duration = parseInt(document.getElementById('exerciseDuration').value);
            if (currentExercise && duration && duration > 0) {
                const sportName = currentExercise.name;
                const exerciseType = currentExercise.type || 'aerobic';
                
                const calories = calculateExerciseCalories(sportName, currentExercise.met, duration);
                const exerciseRecord = {
                    id: Date.now().toString(),
                    name: sportName,
                    duration: duration,
                    calories: Utils.toFixedOne(calories),
                    type: exerciseType
                };
                
                // æ·»åŠ åˆ°è¿åŠ¨è®°å½•
                const record = DataManager.getExerciseRecord(currentDate);
                record.exercises.push(exerciseRecord);
                DataManager.saveExerciseRecord(currentDate, record);
                
                // æ›´æ–°æ˜¾ç¤º
                loadExerciseRecord();
                updateTotalExerciseCalories();
                
                // å…³é—­å¼¹çª—
                durationModal.close();
                currentExercise = null;
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿');
            }
        }

        // æ‰“å¼€æ‰‹åŠ¨æ·»åŠ æœ‰æ°§è¿åŠ¨å¼¹çª—
        function openManualAerobicModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('manualExerciseName').value = '';
            document.getElementById('manualExerciseDuration').value = '';
            document.getElementById('manualExerciseCalories').value = '';
            manualAerobicModal.open();
        }

        // å…³é—­æ‰‹åŠ¨æ·»åŠ æœ‰æ°§è¿åŠ¨å¼¹çª—
        function closeManualAerobicModal() {
            manualAerobicModal.close();
        }

        // æ·»åŠ æ‰‹åŠ¨æœ‰æ°§è¿åŠ¨
        function addManualAerobicExercise() {
            const name = document.getElementById('manualExerciseName').value;
            const duration = parseInt(document.getElementById('manualExerciseDuration').value);
            const calories = parseFloat(document.getElementById('manualExerciseCalories').value);
            
            if (name && duration && duration > 0 && calories !== undefined && calories >= 0) {
                const exerciseRecord = {
                    id: Date.now().toString(),
                    name: name,
                    duration: duration,
                    calories: Utils.toFixedOne(calories),
                    type: 'aerobic'
                };
                
                // æ·»åŠ åˆ°è¿åŠ¨è®°å½•
                const record = DataManager.getExerciseRecord(currentDate);
                record.exercises.push(exerciseRecord);
                DataManager.saveExerciseRecord(currentDate, record);
                
                // æ›´æ–°æ˜¾ç¤º
                loadExerciseRecord();
                updateTotalExerciseCalories();
                
                // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
                localStorage.setItem('adviceRefreshNeeded', 'true');
                
                // å…³é—­å¼¹çª—
                manualAerobicModal.close();
            } else {
                alert('è¯·å¡«å†™å®Œæ•´çš„è¿åŠ¨ä¿¡æ¯ï¼Œè¿åŠ¨åç§°ä¸èƒ½ä¸ºç©º');
            }
        }

        // åŠ è½½è¿åŠ¨è®°å½•
        function loadExerciseRecord() {
            const record = DataManager.getExerciseRecord(currentDate);
            const aerobicList = document.getElementById('aerobicExerciseList');
            const anaerobicList = document.getElementById('anaerobicExerciseList');
            
            // æ¸…ç©ºåˆ—è¡¨
            aerobicList.innerHTML = '';
            anaerobicList.innerHTML = '';
            
            // æ˜¾ç¤ºè¿åŠ¨è®°å½•
            record.exercises.forEach(exercise => {
                // æ ¹æ®è¿åŠ¨ç±»å‹é€‰æ‹©å¯¹åº”çš„åˆ—è¡¨
                const list = exercise.type === 'anaerobic' ? anaerobicList : aerobicList;
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-record';
                exerciseItem.dataset.id = exercise.id;
                // ç¡®ä¿è¿åŠ¨åç§°å­˜åœ¨ï¼Œé»˜è®¤ä½¿ç”¨"æœªçŸ¥è¿åŠ¨"
                const sportName = exercise.name || 'æœªçŸ¥è¿åŠ¨';
                exerciseItem.innerHTML = `
                    <span class="exercise-name">${sportName}</span>
                    <span class="exercise-time">${exercise.duration}åˆ†é’Ÿ</span>
                    <span class="exercise-calorie">${exercise.calories}å¤§å¡</span>
                    <button class="delete-btn" onclick="deleteExercise('${exercise.id}')">Ã—</button>
                `;
                list.appendChild(exerciseItem);
            });
        }

        // åˆ é™¤è¿åŠ¨
        function deleteExercise(exerciseId) {
            const record = DataManager.getExerciseRecord(currentDate);
            record.exercises = record.exercises.filter(exercise => exercise.id !== exerciseId);
            DataManager.saveExerciseRecord(currentDate, record);
            loadExerciseRecord();
            updateTotalExerciseCalories();
            
            // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
            localStorage.setItem('adviceRefreshNeeded', 'true');
        }

        // æ›´æ–°æ€»è¿åŠ¨æ¶ˆè€—
        function updateTotalExerciseCalories() {
            const totalCalories = DataManager.calculateDailyExerciseCalories(currentDate);
            document.getElementById('totalExerciseCalories').textContent = Utils.toFixedOne(totalCalories);
            // å°†è¿åŠ¨æ¶ˆè€—æ›´æ–°åˆ°localStorage
            localStorage.setItem('todayExerciseCalorie', totalCalories);
        }

        // ä¿å­˜è¿åŠ¨è®°å½•
        function saveExerciseRecord() {
            alert('ä»Šæ—¥è¿åŠ¨è®°å½•å·²ä¿å­˜ï¼');
        }
    </script>
</body>
</html>