<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¥®é£Ÿè®°å½• - å¥èº«ç®¡ç†APP</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>é¥®é£Ÿè®°å½•</h1>

        <!-- æ—¥æœŸé€‰æ‹© -->
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="datePicker" class="btn btn-primary">ä»Šæ—¥ <span id="currentDate"></span></button>
        </div>

        <!-- çƒ­é‡ç»Ÿè®¡å¡ç‰‡ -->
        <div class="circle-cards">
            <div class="circle-card small">
                <div class="value" id="foodCalories">0.0</div>
                <div class="label">é¥®é£Ÿæ‘„å…¥</div>
                <div class="label">å¤§å¡</div>
            </div>
            <div class="circle-card large calorie-gap-circle">
                <div class="value" id="calorieDeficit">0.0</div>
                <div class="label">çƒ­é‡ç¼ºå£</div>
                <div class="label">å¤§å¡</div>
            </div>
            <div class="circle-card small">
                <div class="value" id="exerciseCalories">0.0</div>
                <div class="label">è¿åŠ¨æ¶ˆè€—</div>
                <div class="label">å¤§å¡</div>
            </div>
        </div>

        <!-- é£Ÿç‰©åˆ†ç±» -->
        <div>
            <!-- æ—©é¤ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>æ—©é¤</h3>
                    <button class="btn btn-primary" onclick="openAddFoodModal('breakfast')">+</button>
                </div>
                <div id="breakfastList" class="item-list"></div>
            </div>

            <!-- åˆé¤ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>åˆé¤</h3>
                    <button class="btn btn-primary" onclick="openAddFoodModal('lunch')">+</button>
                </div>
                <div id="lunchList" class="item-list"></div>
            </div>

            <!-- æ™šé¤ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>æ™šé¤</h3>
                    <button class="btn btn-primary" onclick="openAddFoodModal('dinner')">+</button>
                </div>
                <div id="dinnerList" class="item-list"></div>
            </div>

            <!-- åŠ é¤ -->
            <div style="margin-bottom: 80px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>åŠ é¤</h3>
                    <button class="btn btn-primary" onclick="openAddFoodModal('snack')">+</button>
                </div>
                <div id="snackList" class="item-list"></div>
            </div>
        </div>

        <!-- ä¿å­˜æŒ‰é’® -->
        <div style="position: fixed; bottom: 70px; left: 0; right: 0; padding: 0 20px; max-width: 480px; margin: 0 auto;">
            <button class="btn btn-primary" onclick="saveDietRecord()">ä¿å­˜ä»Šæ—¥è®°å½•</button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="nav">
        <button class="nav-btn" data-page="index">
            <i>ğŸ‘¤</i>
            <span>ä¸ªäºº</span>
        </button>
        <button class="nav-btn active" data-page="diet">
            <i>ğŸ½ï¸</i>
            <span>é¥®é£Ÿ</span>
        </button>
        <button class="nav-btn" data-page="exercise">
            <i>ğŸƒ</i>
            <span>è¿åŠ¨</span>
        </button>
        <button class="nav-btn" data-page="advice">
            <i>ğŸ’¡</i>
            <span>å»ºè®®</span>
        </button>
    </div>

    <!-- æ—¥æœŸé€‰æ‹©å¼¹çª— -->
        <div id="calendarModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">é€‰æ‹©æ—¥æœŸ <span class="modal-title-date"></span></h3>
                    <button class="btn-close" onclick="closeCalendarModal()">&times;</button>
                </div>
                <div id="calendarContainer" class="calendar"></div>
                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeCalendarModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmDateSelection()" style="margin-left: 10px;">ç¡®è®¤</button>
                </div>
            </div>
        </div>

    <!-- é£Ÿç‰©æ·»åŠ å¼¹çª— -->
    <div id="addFoodModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ é£Ÿç‰©</h3>
                <button class="btn-close" onclick="closeAddFoodModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label for="foodSearch">æœç´¢é£Ÿç‰©</label>
                    <input type="text" id="foodSearch" placeholder="è¾“å…¥é£Ÿç‰©åç§°">
                </div>
                <div id="foodSearchResults" class="item-list" style="max-height: 200px; overflow-y: auto;"></div>
                <div id="manualAddSection" style="display: none;">
                    <h3>æ‰‹åŠ¨æ·»åŠ é£Ÿç‰©</h3>
                    <div class="input-group">
                        <label for="manualFoodName">é£Ÿç‰©åç§°</label>
                        <input type="text" id="manualFoodName" placeholder="è¾“å…¥é£Ÿç‰©åç§°">
                    </div>
                    <div class="input-group">
                        <label for="manualFoodCategory">é£Ÿç‰©åˆ†ç±»</label>
                        <select id="manualFoodCategory" disabled>
                            <option value="è‡ªå®šä¹‰" selected>è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="manualFoodWeight">å…‹æ•° (g)</label>
                        <input type="number" id="manualFoodWeight" placeholder="è¾“å…¥å…‹æ•°" min="0.1" step="0.1" value="100">
                    </div>
                    <div class="input-group">
                        <label for="manualFoodCalories">çƒ­é‡ (å¤§å¡/100g)</label>
                        <input type="number" id="manualFoodCalories" placeholder="è¾“å…¥çƒ­é‡" min="0" step="0.1">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="saveToDatabase" checked>
                        <label for="saveToDatabase">ä¿å­˜åˆ°æ•°æ®åº“</label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addManualFood()">æ·»åŠ æ‰‹åŠ¨é£Ÿç‰©</button>
            </div>
        </div>
    </div>

    <!-- å…‹æ•°è¾“å…¥å¼¹çª— -->
    <div id="weightInputModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¾“å…¥å…‹æ•°</h3>
                <button class="btn-close" onclick="closeWeightInputModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label for="foodWeight">å…‹æ•° (g)</label>
                    <input type="number" id="foodWeight" placeholder="è¾“å…¥å…‹æ•°" min="0.1" step="0.1">
                </div>
                <div style="text-align: center; margin: 15px 0;">
                    <div>çƒ­é‡ï¼š<span id="calculatedCalories">0.0</span> å¤§å¡</div>
                </div>
                <button class="btn btn-primary" onclick="confirmFoodAddition()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è‡ªå®šä¹‰é£Ÿç‰©å¼¹çª— -->
    <div id="editFoodModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘è‡ªå®šä¹‰é£Ÿç‰©</h3>
                <button class="btn-close" onclick="closeEditFoodModal()">&times;</button>
            </div>
            <div>
                <div class="input-group">
                    <label for="editFoodName">é£Ÿç‰©åç§°</label>
                    <input type="text" id="editFoodName" readonly>
                </div>
                <div class="input-group">
                    <label for="editFoodCalories">çƒ­é‡ (å¤§å¡/100g)</label>
                    <input type="number" id="editFoodCalories" placeholder="è¾“å…¥çƒ­é‡" min="0" step="0.1">
                </div>
                <div style="text-align: center; margin: 15px 0;">
                    <div>ä¿®æ”¹åï¼Œåç»­æ·»åŠ æ­¤é£Ÿç‰©å°†ä½¿ç”¨æ–°çš„çƒ­é‡å€¼</div>
                </div>
                <button class="btn btn-primary" onclick="confirmEditFood()">ç¡®è®¤ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script src="js/food-db.js"></script>
        <script src="js/common.js"></script>
        <script src="js/app.js"></script>
    <script>
        // é¥®é£Ÿè®°å½•é¡µåˆå§‹åŒ–
        let currentSelectedDate = new Date();
        let currentMealType = '';
        let selectedFood = null;
        let calendar = null;
        let foodModal = null;
        let weightModal = null;
        let calendarModal = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ—¥æœŸæ˜¾ç¤º
            updateDateDisplay();
            
            // åˆå§‹åŒ–æ—¥å†
            calendarModal = new Modal(document.getElementById('calendarModal'));
            calendar = new Calendar(document.getElementById('calendarContainer'), {
                currentDate: currentSelectedDate,
                onDateSelect: function(date) {
                    // æ›´æ–°å½“å‰é€‰ä¸­æ—¥æœŸ
                    currentSelectedDate = date;
                    // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
                    updateDateDisplay();
                    // åŠ è½½å¯¹åº”æ—¥æœŸçš„é¥®é£Ÿè®°å½•
                    loadDietRecord();
                    // æ›´æ–°çƒ­é‡ç»Ÿè®¡
                    updateCalorieStatistics();
                }
            });
            
            // ç›‘å¬æœˆä»½åˆ‡æ¢æŒ‰é’®ï¼Œç¡®ä¿åˆ‡æ¢æœˆä»½åé‡æ–°æ¸²æŸ“é«˜äº®
        document.addEventListener('click', function(e) {
            if (e.target.id === 'prev-month' || e.target.id === 'next-month') {
                // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿æ—¥å†DOMå·²é‡æ–°æ¸²æŸ“
                setTimeout(highlightSurplusDates, 100);
            }
        });
            
            // åˆå§‹åŒ–å¼¹çª—
            foodModal = new Modal(document.getElementById('addFoodModal'));
            weightModal = new Modal(document.getElementById('weightInputModal'));
            
            // åŠ è½½é¥®é£Ÿè®°å½•
            loadDietRecord();
            
            // æ›´æ–°çƒ­é‡ç»Ÿè®¡
            updateCalorieStatistics();
            
            // æ—¥æœŸé€‰æ‹©å™¨ç‚¹å‡»äº‹ä»¶
            document.getElementById('datePicker').addEventListener('click', function() {
            calendarModal.open();
            // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿æ—¥å†DOMå·²æ¸²æŸ“
            setTimeout(highlightSurplusDates, 100);
        });
            
            // é£Ÿç‰©æœç´¢äº‹ä»¶ - å¼ºåˆ¶æ¿€æ´»
            document.getElementById('foodSearch').addEventListener('input', function() {
                const keyword = this.value;
                if (keyword) {
                    // ç›´æ¥éå†FOOD_DBå…¨å±€æ•°ç»„ï¼ŒåŒ¹é…åç§°å«å…³é”®è¯çš„é£Ÿç‰©
                    const results = [];
                    const lowerKeyword = keyword.toLowerCase();
                    FOOD_DB.forEach(food => {
                        if (food.name.toLowerCase().includes(lowerKeyword)) {
                            results.push({
                                id: `${food.category.toLowerCase()}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                name: food.name,
                                calories: food.calorie,
                                category: food.category
                            });
                        }
                    });
                    displayFoodSearchResults(results);
                } else {
                    document.getElementById('foodSearchResults').innerHTML = '';
                    document.getElementById('manualAddSection').style.display = 'none';
                }
            });
            
            // æ‰‹åŠ¨æ·»åŠ é£Ÿç‰©æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å¼ºåˆ¶æ¿€æ´»
            const manualAddBtn = document.querySelector('[onclick="addManualFood()"]');
            manualAddBtn.className = 'btn btn-primary';
            manualAddBtn.innerHTML = 'æ‰‹åŠ¨æ·»åŠ é£Ÿç‰©';
            manualAddBtn.addEventListener('click', function() {
                // åˆ‡æ¢æ‰‹åŠ¨æ·»åŠ è¡¨å•æ˜¾ç¤ºçŠ¶æ€
                const manualSection = document.getElementById('manualAddSection');
                manualSection.style.display = manualSection.style.display === 'none' ? 'block' : 'none';
            });
            
            // å…‹æ•°è¾“å…¥äº‹ä»¶
            document.getElementById('foodWeight').addEventListener('input', function() {
                if (selectedFood && this.value) {
                    const weight = parseFloat(this.value);
                    const calories = (weight / 100) * selectedFood.calories;
                    document.getElementById('calculatedCalories').textContent = Utils.toFixedOne(calories);
                }
            });
        });

        // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
        function updateDateDisplay() {
            document.getElementById('currentDate').textContent = Utils.formatDate(currentSelectedDate);
        }

        // æ‰“å¼€æ—¥æœŸé€‰æ‹©å¼¹çª—
        function openCalendarModal() {
            calendarModal.open();
        }

        // å…³é—­æ—¥æœŸé€‰æ‹©å¼¹çª—
        function closeCalendarModal() {
            calendarModal.close();
        }

        // ç¡®è®¤æ—¥æœŸé€‰æ‹©
        function confirmDateSelection() {
            const selectedDate = calendar.getSelectedDate();
            if (selectedDate) {
                currentSelectedDate = selectedDate;
                updateDateDisplay();
                loadDietRecord();
                updateCalorieStatistics();
                calendarModal.close();
            }
        }

        // æ‰“å¼€é£Ÿç‰©æ·»åŠ å¼¹çª—
        function openAddFoodModal(mealType) {
            currentMealType = mealType;
            // é‡ç½®æœç´¢æ¡†å’Œç»“æœ
            document.getElementById('foodSearch').value = '';
            document.getElementById('foodSearchResults').innerHTML = '';
            document.getElementById('manualAddSection').style.display = 'none';
            foodModal.open();
        }

        // å…³é—­é£Ÿç‰©æ·»åŠ å¼¹çª—
        function closeAddFoodModal() {
            foodModal.close();
        }

        // æ˜¾ç¤ºé£Ÿç‰©æœç´¢ç»“æœ - å¼ºåˆ¶æ¿€æ´»
        function displayFoodSearchResults(results) {
            const resultsContainer = document.getElementById('foodSearchResults');
            resultsContainer.innerHTML = '';
            
            if (results.length > 0) {
                results.forEach(food => {
                    const li = document.createElement('li');
                    li.className = 'search-result-item';
                    li.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                    li.innerHTML = `
                        <span>${food.name} (${food.calories}å¤§å¡/100g)</span>
                    `;
                    li.onclick = function() {
                        selectFood(food);
                    };
                    resultsContainer.appendChild(li);
                });
                document.getElementById('manualAddSection').style.display = 'none';
            } else {
                resultsContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">æœªæ‰¾åˆ°åŒ¹é…çš„é£Ÿç‰©</div>';
                // æœç´¢æ— ç»“æœæ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ‰‹åŠ¨æ·»åŠ æŒ‰é’®
                document.getElementById('manualAddSection').style.display = 'block';
            }
        }

        // é€‰æ‹©é£Ÿç‰©
        function selectFood(food) {
            selectedFood = food;
            document.getElementById('foodWeight').value = '';
            document.getElementById('calculatedCalories').textContent = '0.0';
            closeAddFoodModal();
            weightModal.open();
        }

        // å…³é—­å…‹æ•°è¾“å…¥å¼¹çª—
        function closeWeightInputModal() {
            weightModal.close();
        }

        // ç¡®è®¤æ·»åŠ é£Ÿç‰©
        function confirmFoodAddition() {
            const weight = parseFloat(document.getElementById('foodWeight').value);
            if (selectedFood && weight && weight > 0) {
                const calories = (weight / 100) * selectedFood.calories;
                const foodRecord = {
                    id: Date.now().toString(),
                    name: selectedFood.name,
                    weight: weight,
                    quantity: weight / 100, // è½¬æ¢ä¸ºä»¥100gä¸ºå•ä½çš„åˆ†é‡
                    calories: Utils.toFixedOne(calories),
                    mealType: currentMealType
                };
                
                // æ·»åŠ åˆ°é¥®é£Ÿè®°å½•
                const record = DataManager.getDietRecord(currentSelectedDate);
                record.foods.push(foodRecord);
                DataManager.saveDietRecord(currentSelectedDate, record);
                
                // è®¡ç®—å¹¶æ›´æ–°todayDietIntakeåˆ°localStorage
                const todayDietIntake = DataManager.calculateDailyFoodCalories(currentSelectedDate);
                localStorage.setItem('todayDietIntake', todayDietIntake);
                
                // æ›´æ–°æ˜¾ç¤º
                loadDietRecord();
                updateCalorieStatistics();
                calculateCalorieBalance();
                
                // å…³é—­å¼¹çª—
                weightModal.close();
                selectedFood = null;
                
                // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
                localStorage.setItem('adviceRefreshNeeded', 'true');
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å…‹æ•°');
            }
        }

        // ç¼–è¾‘è‡ªå®šä¹‰é£Ÿç‰©
        let currentEditFoodName = '';
        
        function editCustomFood(foodName) {
            currentEditFoodName = foodName;
            
            // æŸ¥æ‰¾è¯¥é£Ÿç‰©åœ¨æ•°æ®åº“ä¸­çš„ä¿¡æ¯
            const targetFood = FOOD_DB.find(item => item.name === foodName && item.category === 'è‡ªå®šä¹‰');
            if (targetFood) {
                // æ˜¾ç¤ºç¼–è¾‘å¼¹çª—
                document.getElementById('editFoodName').value = foodName;
                document.getElementById('editFoodCalories').value = targetFood.calorie;
                document.getElementById('editFoodModal').style.display = 'block';
            }
        }
        
        function closeEditFoodModal() {
            document.getElementById('editFoodModal').style.display = 'none';
            currentEditFoodName = '';
        }
        
        function confirmEditFood() {
        const newCalorie = parseFloat(document.getElementById('editFoodCalories').value);
        
        if (isNaN(newCalorie) || newCalorie < 0) {
            alert('è¯·å¡«å†™æœ‰æ•ˆçš„çƒ­é‡å€¼');
            return;
        }
        
        // è°ƒç”¨å…¨å±€å‡½æ•°ä¿®æ”¹æ•°æ®åº“ä¸­çš„é£Ÿç‰©
        editFoodInDB(currentEditFoodName, newCalorie);
        
        // æ›´æ–°å½“å‰è®°å½•ä¸­ä½¿ç”¨è¯¥é£Ÿç‰©çš„æ¡ç›®
        const record = DataManager.getDietRecord(currentSelectedDate);
        record.foods.forEach(food => {
            if (food.name === currentEditFoodName && (food.isCustom || food.category === 'è‡ªå®šä¹‰')) {
                // é‡æ–°è®¡ç®—çƒ­é‡ï¼š(æ–°çš„æ¯100gçƒ­é‡/100)*å…‹æ•°
                food.calories = Utils.toFixedOne((newCalorie / 100) * food.weight);
            }
        });
        DataManager.saveDietRecord(currentSelectedDate, record);
        
        // è®¡ç®—å¹¶æ›´æ–°todayDietIntakeåˆ°localStorage
        const todayDietIntake = DataManager.calculateDailyFoodCalories(currentSelectedDate);
        localStorage.setItem('todayDietIntake', todayDietIntake);
        
        // æ›´æ–°æ˜¾ç¤º
        loadDietRecord();
        updateCalorieStatistics();
        calculateCalorieBalance();
        
        // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
        localStorage.setItem('adviceRefreshNeeded', 'true');
        
        // å…³é—­å¼¹çª—
        closeEditFoodModal();
        
        alert('é£Ÿç‰©çƒ­é‡å·²æ›´æ–°');
    }
        
        // æ·»åŠ æ‰‹åŠ¨é£Ÿç‰© - å¼ºåˆ¶æ¿€æ´»
        function addManualFood() {
            const manualSection = document.getElementById('manualAddSection');
            
            // å¦‚æœæ‰‹åŠ¨æ·»åŠ è¡¨å•å·²ç»æ˜¾ç¤ºï¼Œåˆ™å¤„ç†æ·»åŠ é€»è¾‘
            if (manualSection.style.display === 'block') {
                const name = document.getElementById('manualFoodName').value;
                const weight = parseFloat(document.getElementById('manualFoodWeight').value) || 100;
                const caloriesPer100g = parseFloat(document.getElementById('manualFoodCalories').value);
                const saveToDatabase = document.getElementById('saveToDatabase').checked;
                
                // å¿…å¡«é¡¹æ ¡éªŒ
                if (!name.trim()) {
                    alert('è¯·å¡«å†™é£Ÿç‰©åç§°');
                    return;
                }
                if (isNaN(weight) || weight <= 0) {
                    alert('è¯·å¡«å†™æœ‰æ•ˆçš„å…‹æ•°');
                    return;
                }
                if (isNaN(caloriesPer100g) || caloriesPer100g < 0) {
                    alert('è¯·å¡«å†™æœ‰æ•ˆçš„çƒ­é‡å€¼');
                    return;
                }
                
                // è®¡ç®—çƒ­é‡ï¼š(æ¯100gçƒ­é‡/100)*å…‹æ•°
                const calories = (caloriesPer100g / 100) * weight;
                const foodRecord = {
                    id: Date.now().toString(),
                    name: name,
                    weight: weight,
                    quantity: weight / 100, // è½¬æ¢ä¸ºä»¥100gä¸ºå•ä½çš„åˆ†é‡
                    calories: Utils.toFixedOne(calories),
                    mealType: currentMealType,
                    category: 'è‡ªå®šä¹‰',
                    isCustom: true
                };
                
                // å¦‚æœå‹¾é€‰äº†ä¿å­˜åˆ°æ•°æ®åº“
                if (saveToDatabase) {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåçš„è‡ªå®šä¹‰é£Ÿç‰©
                    const existingFood = FOOD_DB.find(item => item.name === name && item.category === 'è‡ªå®šä¹‰');
                    if (!existingFood) {
                        // è°ƒç”¨å…¨å±€å‡½æ•°æ·»åŠ åˆ°æ•°æ®åº“
                        addFoodToDB({
                            name: name,
                            category: 'è‡ªå®šä¹‰',
                            calorie: caloriesPer100g
                        });
                    }
                }
                
                // æ·»åŠ åˆ°é¥®é£Ÿè®°å½•
                const record = DataManager.getDietRecord(currentSelectedDate);
                record.foods.push(foodRecord);
                DataManager.saveDietRecord(currentSelectedDate, record);
                
                // è®¡ç®—å¹¶æ›´æ–°todayDietIntakeåˆ°localStorage
                const todayDietIntake = DataManager.calculateDailyFoodCalories(currentSelectedDate);
                localStorage.setItem('todayDietIntake', todayDietIntake);
                
                // æ›´æ–°æ˜¾ç¤º
                loadDietRecord();
                updateCalorieStatistics();
                calculateCalorieBalance();
                
                // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
                localStorage.setItem('adviceRefreshNeeded', 'true');
                
                // å…³é—­å¼¹çª—
                foodModal.close();
                
                // é‡ç½®æ‰‹åŠ¨æ·»åŠ è¡¨å•
                document.getElementById('manualFoodName').value = '';
                document.getElementById('manualFoodWeight').value = '100';
                document.getElementById('manualFoodCalories').value = '';
                document.getElementById('saveToDatabase').checked = true;
                manualSection.style.display = 'none';
            } else {
                // å¦åˆ™æ˜¾ç¤ºæ‰‹åŠ¨æ·»åŠ è¡¨å•
                manualSection.style.display = 'block';
            }
        }

        // åŠ è½½é¥®é£Ÿè®°å½•
        function loadDietRecord() {
            const record = DataManager.getDietRecord(currentSelectedDate);
            
            // æ¸…ç©ºæ‰€æœ‰é¤é£Ÿåˆ—è¡¨
            ['breakfast', 'lunch', 'dinner', 'snack'].forEach(mealType => {
                document.getElementById(`${mealType}List`).innerHTML = '';
            });
            
            // æŒ‰é¤é£Ÿç±»å‹æ˜¾ç¤ºé£Ÿç‰©
            record.foods.forEach(food => {
                const list = document.getElementById(`${food.mealType}List`);
                const foodItem = document.createElement('div');
                foodItem.className = 'item';
                foodItem.dataset.id = food.id;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰é£Ÿç‰©
                const isCustomFood = food.isCustom || food.category === 'è‡ªå®šä¹‰';
                
                foodItem.innerHTML = `
                    <div>
                        <div class="name">${food.name}</div>
                        <div style="font-size: 12px; color: #999;">${food.weight}g</div>
                        ${isCustomFood ? '<div style="font-size: 12px; color: #5cb85c;">[è‡ªå®šä¹‰]</div>' : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="calories">${food.calories} å¤§å¡</div>
                        ${isCustomFood ? `<button class="btn-edit" onclick="editCustomFood('${food.name}')">ç¼–è¾‘</button>` : ''}
                        <button class="btn-delete" onclick="deleteFood('${food.id}')">&times;</button>
                    </div>
                `;
                list.appendChild(foodItem);
            });
        }

        // åˆ é™¤é£Ÿç‰©
        function deleteFood(foodId) {
            const record = DataManager.getDietRecord(currentSelectedDate);
            record.foods = record.foods.filter(food => food.id !== foodId);
            DataManager.saveDietRecord(currentSelectedDate, record);
            
            // è®¡ç®—å¹¶æ›´æ–°todayDietIntakeåˆ°localStorage
            const todayDietIntake = DataManager.calculateDailyFoodCalories(currentSelectedDate);
            localStorage.setItem('todayDietIntake', todayDietIntake);
            
            loadDietRecord();
            updateCalorieStatistics();
            calculateCalorieBalance();
            
            // è§¦å‘æ™ºèƒ½å»ºè®®åˆ·æ–°
            localStorage.setItem('adviceRefreshNeeded', 'true');
        }

        // æ›´æ–°çƒ­é‡ç»Ÿè®¡
        function updateCalorieStatistics() {
            const userInfo = DataManager.getUserInfo();
            const foodCalories = DataManager.calculateDailyFoodCalories(currentSelectedDate);
            const exerciseCalories = DataManager.calculateDailyExerciseCalories(currentSelectedDate);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('foodCalories').textContent = Utils.toFixedOne(foodCalories);
            document.getElementById('exerciseCalories').textContent = Utils.toFixedOne(exerciseCalories);
            
            // æ›´æ–°localStorageä¸­çš„å€¼
            localStorage.setItem('todayDietIntake', foodCalories);
            localStorage.setItem('todayExerciseCalorie', exerciseCalories);
            if (userInfo && userInfo.tdee) {
                localStorage.setItem('userTDEE', userInfo.tdee);
            }
        }

        // ä¿å­˜é¥®é£Ÿè®°å½•
        function saveDietRecord() {
            alert('ä»Šæ—¥é¥®é£Ÿè®°å½•å·²ä¿å­˜ï¼');
            // ä¿å­˜åé‡æ–°æ¸²æŸ“æ—¥å†é«˜äº®
            highlightSurplusDates();
            // é€šçŸ¥æ™ºèƒ½å»ºè®®é¡µé¢åˆ·æ–°
            localStorage.setItem('adviceRefreshNeeded', 'true');
        }
    </script>
</body>
</html>